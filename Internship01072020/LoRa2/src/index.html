<!DOCTYPE html>
<html>

<head>
	<title></title>
	<meta charset="utf-8" />
</head>

<body>
	<script>
		window.onload = function () {

			// check to see if user has metamask addon installed on his browser. check to make sure web3 is defined
			/*if (typeof web3 === 'undefined') {
			document.getElementById('metamask').innerHTML = 'You need <a href="https://metamask.io/">MetaMask</a> browser plugin to run this example'
			}*/

			var web3 = new Web3(Web3.currentProvider || 'http://localhost:7545');

			// call the getvalue function here
			//getvalue();
		}
		//function to retrieve the last inserted value on the blockchain

		function getvalue() {
			try {
				// contract Abi defines all the variables,constants and functions of the smart contract. replace with your own abi
				var abi = [
					{
						"constant": true,
						"inputs": [
							{
								"internalType": "uint256",
								"name": "_sensorId",
								"type": "uint256"
							}
						],
						"name": "getOutput",
						"outputs": [
							{
								"internalType": "uint256[]",
								"name": "",
								"type": "uint256[]"
							},
							{
								"internalType": "uint256[]",
								"name": "",
								"type": "uint256[]"
							},
							{
								"internalType": "uint256[]",
								"name": "",
								"type": "uint256[]"
							},
							{
								"internalType": "uint256",
								"name": "",
								"type": "uint256"
							},
							{
								"internalType": "bytes32[]",
								"name": "",
								"type": "bytes32[]"
							}
						],
						"payable": false,
						"stateMutability": "view",
						"type": "function"
					},
					{
						"constant": false,
						"inputs": [
							{
								"internalType": "uint256",
								"name": "_sensorId",
								"type": "uint256"
							},
							{
								"internalType": "bytes32",
								"name": "_hash",
								"type": "bytes32"
							}
						],
						"name": "setHash",
						"outputs": [],
						"payable": false,
						"stateMutability": "nonpayable",
						"type": "function"
					},
					{
						"constant": false,
						"inputs": [
							{
								"internalType": "uint256",
								"name": "_sensorId",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "_temperature",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "_stress",
								"type": "uint256"
							}
						],
						"name": "setInput",
						"outputs": [],
						"payable": false,
						"stateMutability": "nonpayable",
						"type": "function"
					}
				]

				var contractaddress = '0x053ea17C5Ea2c2d0B482AabCD0DD0550f9f90eEC';
				//instantiate and connect to contract address via Abi
				var myAbi = web3.eth.contract(abi);
				var myfunction = myAbi.at(contractaddress);

				//convert time format
				function funcTime(unixtimestamp) {
					// Unixtimestamp
					//var unixtimestamp = xname[2][i-1];

					// Months array
					var months_arr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

					// Convert timestamp to milliseconds
					var date = new Date(unixtimestamp * 1000);

					// Year
					var year = date.getFullYear();

					// Month
					var month = months_arr[date.getMonth()];

					// Day
					var day = date.getDate();

					// Hours
					var hours = date.getHours();

					// Minutes
					var minutes = "0" + date.getMinutes();

					// Seconds
					var seconds = "0" + date.getSeconds();

					// Display date time in MM-dd-yyyy h:m:s format
					var convdataTime = month + '-' + day + '-' + year + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
					return convdataTime;
				}

				//convert decimal point
				function funcDec(tmp) {
					var xname1_str = tmp.toString();
					var xname1_size = xname1_str.length;
					var first_xname1 = xname1_str.slice(0, xname1_size - 2);
					var second_xname1 = xname1_str.slice(xname1_size - 2, xname1_size);
					tmp = first_xname1.concat('.' + second_xname1);

					return tmp;

				}
				//call the get function of our SimpleStorage contract
				myfunction.getOutput.call(document.getElementById("xvalue1").value, function (err, xname) {
					var table = document.getElementById("myTable");

					//var transaction = myfunction.getTransaction('0x6554874a8229abe65638202ad63d89a6783c497193edf4ae5eb1a819eba574f8');
					//document.getElementById("demo").innerHTML = "Found " + transaction + " tr elements in the table.";


					//duplicate row
					//bypass metamask
					//listen from port       

					if (err) { console.log(err) }
					if (xname) {






						//display value on the webpage

						for (var i = xname[3]; i > 0; i--) {



							//console.log(xname[4][i-1]);
							var row = table.insertRow(xname[3] - i + 1);
							var cell1 = row.insertCell(0);



							var cell2 = row.insertCell(1);
							var cell3 = row.insertCell(2);
							var cell4 = row.insertCell(3);


							//cell2.innerHTML = " " + xname[0][i-1] + " °C";
							cell2.innerHTML = " " + funcDec(xname[0][i - 1]) + " °C";


							//cell3.innerHTML = " " + xname[1][i-1] +" kN";
							cell3.innerHTML = " " + funcDec(xname[1][i - 1]) + " kN";

							cell4.innerHTML = " " + xname[4][i - 1];
							var converTime = funcTime(xname[2][i - 1]);



							cell1.innerHTML = converTime;




						}
					}
					//convert();

				});
			}
			catch (err) {
				document.getElementById("xtemp").innerHTML = err;
				document.getElementById("xstress").innerHTML = err;
			}
		}
		// function to add a new integer value to the blockchain
		function setvalue() {
			try {
				// contract Abi defines all the variables,constants and functions of the smart contract. replace with your own abi
				var abi = [
					{
						"constant": true,
						"inputs": [
							{
								"internalType": "uint256",
								"name": "_sensorId",
								"type": "uint256"
							}
						],
						"name": "getOutput",
						"outputs": [
							{
								"internalType": "uint256[]",
								"name": "",
								"type": "uint256[]"
							},
							{
								"internalType": "uint256[]",
								"name": "",
								"type": "uint256[]"
							},
							{
								"internalType": "uint256[]",
								"name": "",
								"type": "uint256[]"
							},
							{
								"internalType": "uint256",
								"name": "",
								"type": "uint256"
							},
							{
								"internalType": "bytes32[]",
								"name": "",
								"type": "bytes32[]"
							}
						],
						"payable": false,
						"stateMutability": "view",
						"type": "function"
					},
					{
						"constant": false,
						"inputs": [
							{
								"internalType": "uint256",
								"name": "_sensorId",
								"type": "uint256"
							},
							{
								"internalType": "bytes32",
								"name": "_hash",
								"type": "bytes32"
							}
						],
						"name": "setHash",
						"outputs": [],
						"payable": false,
						"stateMutability": "nonpayable",
						"type": "function"
					},
					{
						"constant": false,
						"inputs": [
							{
								"internalType": "uint256",
								"name": "_sensorId",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "_temperature",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "_stress",
								"type": "uint256"
							}
						],
						"name": "setInput",
						"outputs": [],
						"payable": false,
						"stateMutability": "nonpayable",
						"type": "function"
					}
				]

				//ethereum.enable();
				//contract address. please change the address to your own
				//var contractaddress = '0x86b87C20baD15964489806F954e72f1f90229512';
				//  var contractaddress = '0x5a028dBE4ab28C0269bc744b1c36757D4d77FeD1';
				var contractaddress = '0x053ea17C5Ea2c2d0B482AabCD0DD0550f9f90eEC';
				//instantiate and connect to contract address via Abi
				var myAbi = web3.eth.contract(abi);
				var myfunction = myAbi.at(contractaddress);

				myfunction.setInput.sendTransaction(document.getElementById("ins_ID").value, document.getElementById("ins_Temp").value, document.getElementById("ins_Stress").value, { from: web3.eth.accounts[0], gas: 4000000 }, function (error, result) {
					if (!error) {
						console.log("test");
						var trans_hash = result;
						myfunction.setHash.sendTransaction(document.getElementById("ins_ID").value, trans_hash, { from: web3.eth.accounts[0], gas: 4000000 }, function (error, result) {
							//myfunciton.setHash.call(document.getElementById("ins_ID").value,contractaddress, function(error,result){

							//npmconsole.log("i am here");
							if (!error) {
								console.log(result);
							}
							else {
								console.log(error);
							}
						});
						//console.log(trans_hash);
					}
					else {
						//console.log(error);
					}
				});
			} catch (err) {
				console.log(err);
				document.getElementById("ins_ID").innerHTML = err;
				document.getElementById("ins_Temp").innerHTML = err;
				document.getElementById("ins_Stress").innerHTML = err;
			}

		}


		function clearrow() {
			var table = document.getElementById("myTable");
			var x = table.rows.length;
			for (var i = 1; i < x; i++) {
				table.deleteRow(1);
			}
		}



	</script>
	<center>
		<div id="metamask"></div>
		<h2>LoRa Based Precision Wireless Structural Health Monitoring System</h2>
		<br />
		<h3>Query data from blockchain</h3>
		<table>
			<tr>
				<td>Insert sensor ID :</td>
				<td>
					<input id="xvalue1" type="text" />
					<input id="Button1" type="button" onclick="getvalue()" value="Enter" />
					<input id="Button3" type="button" onclick="clearrow()" value="Clear" />
				</td>
			</tr>
		</table>

		<table id="myTable" , style="width:100%" , border="1px solid black" , border-collapse="collapse">
			<tr>
				<th>Timestamp</th>
				<th>Temperature</th>
				<th>Force</th>
				<th>Transaction Hash</th>
			</tr>
		</table>
		<h3>Insert data to blockchain</h2>
			<table>
				<tr>
					<td>Insert sensor ID :</td>
					<td>
						<input id="ins_ID" type="text" />
					</td>
				</tr>
				<tr>
					<td> Temperature:</td>
					<td>
						<input id="ins_Temp" type="text" />
					</td>
				</tr>
				<tr>
					<td> Force:</td>
					<td>
						<input id="ins_Stress" type="text" />
					</td>
				</tr>
				<tr>
					<td>
						<input id="Button2" type="button" onclick="setvalue()" value="Enter" />
					</td>
				</tr>
				<p id="demo"></p>
			</table>
	</center>
</body>

</html>